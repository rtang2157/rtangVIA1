<DashboardPluginModel description="" name="Admin - Plugin" is_init="false">
  <ModelInfo validated="true">
    <Properties>
    </Properties>
    <Widgets>
      <Widget name="Action Bar" private="false">
        <PropertyText>
          <![CDATA[[{
    "name" : "model",
    "label" : "Model",
    "type" : "json"
}]]]>
        </PropertyText>
        <CodeText segment="#constructor">
          <![CDATA[
            if (this.initialConfig.properties != null && this.initialConfig.properties.model != null && this.initialConfig.properties.model.trim() != "") {
                this._model = JSON.parse(this.initialConfig.properties.model);
            }
            
            this._BUSY = {
                id     : "GJK56734657657540RI90:" + this.id,
                label  : "...",
                cancel : null
            };]]>
        </CodeText>
        <CodeText segment="#postCreate">
          <![CDATA[            if (this._model != null || this._useDummyModel()) {
                this._drawLayout();
            }]]>
        </CodeText>
        <CodeText segment="#methods">
          <![CDATA[        _drawLayout: function() {
            AppUtil.removeAllChildrenOf(this.domNode);
            if (this._model == null && this._useDummyModel()) {
                var self = this;
                this._getDummyModel(function(t) {
                    self._model = JSON.parse(t);
                    if (self._model.menubar != null) {
                        self._createMenuBar(self._model.menubar);
                    }
                    if (self._model.toolbar != null) {
                        self._createToolBar(self._model.toolbar);
                    }
                    if (self._model.sidebar != null) {
                        self._createSideBar(self._model.sidebar);
                    }
                });
            }
            else {
                if (this._model.menubar != null) {
                    this._createMenuBar(this._model.menubar);
                }
                if (this._model.toolbar != null) {
                    this._createToolBar(this._model.toolbar);
                }
                if (this._model.sidebar != null) {
                    this._createSideBar(this._model.sidebar);
                }
            }

            this.doRefresh();
        },
        
        _createMenuBar : function(defs) {
            this._menubarItems = {};
            var div = domConstruct.create("div", {
                style : "width:100%;height:auto;"
            });
            this.domNode.appendChild(div);
            
            var self = this;
            parseMenuBarDefs(this._menubarItems, [], null, defs, function(value) {
                var item = self._menubarItems[value];
                if (item != null) {
                    self._onSelect("menubarSelect", item, value);
                }
            }, function(menubar) {
                self._menubar = menubar;
                self._menubar.placeAt(div);
                self._menubar.startup();
            });
        },

        _createToolBar : function(defs, callback) {
            this._toolbarItems = {};
            var div = domConstruct.create("div", {
                style : "width:100%;height:auto;"
            });
            this.domNode.appendChild(div);

            var self = this;
            parseToolBarDefs(this._toolbarItems, defs, function(value) {
                var item = self._toolbarItems[value];
                if (item != null) {
                    self._onSelect("toolbarSelect", item, value);
                }
            }, function(toolbar) {
                self._toolbar = toolbar;
                self._toolbar.placeAt(div);
                self._toolbar.startup();
                
                if (self._menubarItems != null) {
                    // has menubar
                    domStyle.set(self._toolbar.domNode, {
                        "border" : "1px solid #b5bcc7",
                        "border-top" : "none",
                    });
                }
                else {
                    // toolbar only
                    domStyle.set(self._toolbar.domNode, {
                        "border" : "1px solid #b5bcc7",
                    });
                }
            });
        },

        _createSideBar : function(defs) {
            this._sidebaritems = {};
            var div = domConstruct.create("div", {
                style : "width:100%;height:auto;"
            });
            this.domNode.appendChild(div);
            
            var self = this;
            parseSideBarDefs(this._sidebaritems, [], null, defs, function(value) {
                var item = self._sidebaritems[value];
                if (item != null) {
                    self._onSelect("sidebarSelect", item, value);
                }
            }, function(sidebar) {
                self._sidebar = sidebar;
                self._sidebar.placeAt(div);
                self._sidebar.startup();
                domStyle.set(self._sidebar.domNode, {
                    "width" : "100%",
                    "background-color" : "#efefef",
                    "background-repeat": "repeat-x",
                    "background-image": "linear-gradient(rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 100%)",
                });
            });
        },

        _onSelect : function(type, item, value) {
            var selection = [];
            if (item.config != null) {
                var config = item.config || {};
                switch (config.action) {
                    case "#doUploadFile":
                        var self = this;
                        doUploadFile(config.mimeTypes, config.content, function(file) {
                            selection.push({
                                "type"  : type,
                                "value" : value,
                                "data"  : JSON.stringify(file)
                            });
                            self._updateSelection(selection);
                        });
                        break;
                }
            }
            else {
                // just pass value string
                selection.push({
                    "type"  : type,
                    "value" : value,
                    "data"  : null
                })
                this._updateSelection(selection);
            }
        },

        _updateSelection : function(selection) {
            if (this.renderer.tile != null) {
                // use this.renderer.tile._onSelectionChange() to direct selection via Selection port
                this.renderer.tile._onSelectionChange(selection);
                
                // use this.renderer.tile._doubleClickOnSelection() to direct selection via Drilldown port
            	this.renderer.tile._doubleClickOnSelection(selection);
            }
        },

        _useDummyModel : function() {
            if (this.controller.initialConfig.appId == "dbp") {
                // in Dashboard Plugin app... so either modeling preview or summary preview
                return true;
            }
            if (this.controller.initialConfig.appId == "ax" && this.controller.mode == "edit.model") {
                // in dashboard builder modeling context
                return true;
            }
            return false;
        },

        _getDummyModel : function(callback) {
            var uri = this.properties._model.substring(0, this.properties._model.lastIndexOf("/"));
            doREST("get", uri + "/SAMPLE", null, null, callback);
        },]]>
        </CodeText>
        <CodeText segment="#functions">
          <![CDATA[    
    function parseMenuBarDefs(menubarItems, path, menu, defs, onSelect, onComplete)
    {
        require(["dijit/MenuBar",
                 "dijit/PopupMenuBarItem",
                 "dijit/PopupMenuItem",
                 "dijit/Menu",
                 "dijit/MenuItem",
                 "dijit/MenuSeparator",
                 "dijit/DropDownMenu",
                 "dojo/domReady!"],
                 function(MenuBar,
                          PopupMenuBarItem,
                          PopupMenuItem,
                          Menu,
                          MenuItem,
                          MenuSeparator,
                          DropDownMenu) {
            if (menu == null) {
                menu = new MenuBar({});
            }
            for (var i=0; i<defs.length; i++) {
                var def = defs[i];
                var itemPath = path.slice(0).concat(def.value);
                if (def.items != null) {
                    if (path.length == 0) {
                        // dropdown menu
                        var dropdownMenu = new DropDownMenu({});
                        parseMenuBarDefs(menubarItems, itemPath, dropdownMenu, def.items, onSelect, null);
                        var popupItem = new PopupMenuBarItem({
                            label: def.label,
                            popup: dropdownMenu
                        });
                        menu.addChild(popupItem);
                        domClass.add(popupItem.domNode, "actionItem");
                        //menubarItems[itemPath.join("/")] = popupItem;
                    }
                    else {
                        // nested menu
                        var dropdownMenu = new Menu({});
                        parseMenuBarDefs(menubarItems, itemPath, dropdownMenu, def.items, onSelect, null);
                        var popupItem = new PopupMenuItem({
                            label: def.label,
                            popup: dropdownMenu
                        });
                        menu.addChild(popupItem);
                        domClass.add(popupItem.domNode, "actionItem");
                        //menubarItems[itemPath.join("/")] = popupItem;
                    }
                }
                else {
                    // menu item
                    var menuItem = new MenuItem({
                        label : def.label,
                        iconClass: def.icon,
                        onClick : lang.partial(onSelect, itemPath.join("/")),
                    });
                    menu.addChild(menuItem);
                    domClass.add(menuItem.domNode, "actionItem");
                    def.widget = menuItem;
                    menubarItems[itemPath.join("/")] = def;
                }
            }
            if (onComplete != null) {
                onComplete(menu);
            }
        });
    }
    
    function parseToolBarDefs(toolbarItems, defs, onSelect, onComplete)
    {
        require(["dijit/form/Button", "dijit/Toolbar", "dojo/domReady!"], function(Button, Toolbar) {
            var toolbar = new Toolbar({});
            for (var i=0; i<defs.length; i++) {
                var def = defs[i];
                if (def.label != null) {
                    // toolbar item
                    var itemName = def.value || def.label;
                    var button = new Button({
                        name : def.value,
                        label : def.label,
                        showLabel : def.icon == null,
                        iconClass: def.icon,
                        onClick : lang.partial(function(value) {
                            onSelect(value);
                        }, def.value),
                    });
                    button.startup();
                    toolbar.addChild(button);
                    def.widget = button;
                    toolbarItems[def.value] = def;
                }
            }
            onComplete(toolbar);
        });
    }
    
    function parseSideBarDefs(sidebarItems, path, menu, defs, onSelect, onComplete)
    {
        require(["dijit/PopupMenuBarItem",
                 "dijit/PopupMenuItem",
                 "dijit/Menu",
                 "dijit/MenuItem",
                 "dijit/MenuSeparator",
                 "dijit/DropDownMenu",
                 "dojo/domReady!"],
                 function(PopupMenuBarItem,
                          PopupMenuItem,
                          Menu,
                          MenuItem,
                          MenuSeparator,
                          DropDownMenu) {
            if (menu == null) {
                menu = new Menu({});
            }
            for (var i=0; i<defs.length; i++) {
                var def = defs[i];
                var itemPath = path.slice(0).concat(def.value);
                if (def.items != null) {
                    // nested menu
                    var dropdownMenu = new Menu({});
                    parseSideBarDefs(sidebarItems, itemPath, dropdownMenu, def.items, onSelect, null);
                    var popupItem = new PopupMenuItem({
                        label: def.label,
                        popup: dropdownMenu
                    });
                    menu.addChild(popupItem);
                    //sidebarItems[itemPath.join("/")] = popupItem;
                }
                else {
                    // menu item
                    var menuItem = new MenuItem({
                        label : def.label,
                        iconClass: def.icon,
                        onClick : lang.partial(onSelect, itemPath.join("/")),
                    });
                    menu.addChild(menuItem);
                    def.widget = menuItem;
                    sidebarItems[itemPath.join("/")] = def;
                }
            }
            if (onComplete != null) {
                onComplete(menu);
            }
        });
    }
    
    function setBusy() {
        require(["af/utils/Indicator"], function (Indicator) {
            Indicator.busy(this._BUSY, dom.byId("body"), false);
        });
    }
    
    function releaseBusy() {
        require(["af/utils/Indicator"], function (Indicator) {
            Indicator.release(this._BUSY, dom.byId("body"), true);
        });    
    }

    function doUploadFile(mimeTypes, content, callback)
    {
        require(["af/controls/FileUploadHelper", "dojo/domReady!"], function(FileUploadHelper) {
            var helper = new FileUploadHelper();
            var widget = helper.getUploader({
                showLabel: false,
                autoWidth : true,
                label: "",
                "class": "clear-dijit-style",
                indicator : true,
                onChangeHandler: function(file) {
                    // file = {"index":0,"name":"DatabaseResources-hello.zip","size":134330,"type":"application/x-zip-compressed","uploadType":"html5"}
                    console.debug("onChangeHandler");
                    //setBusy();
                    window._vtUploadedFile = file;
                },
                uploadCompleteHandler: function(data) {
                    // data = {uid:"743f8540-2991-478a-8e2d-45743c4a3a7a"}
                    console.debug("uploadCompleteHandler");
                    //releaseBusy();
                    if (window._vtUploadedFile != null) {
                        if (mimeTypes == null || mimeTypes == "" || mimeTypes.indexOf(window._vtUploadedFile.type) != -1) {
                            window._vtUploadedFile.uid = data.uid;
                            if (content == true) {
                                // grab file content... ascii ONLY
                                // /vitria-oi/rest/app/dojoclient/user/vtbaadmin/PRBB Model.zip?op=download&uid=ae85ac91-930a-4885-85ce-de916faf8dc7
                                GET("/vitria-oi/rest/app/dojoclient/user/vtbaadmin/foo.txt", {op:"download", uid:data.uid}, function(t) {
                                    window._vtUploadedFile.status = "OK";
                                    window._vtUploadedFile.content = t;
                                    callback(window._vtUploadedFile);
                                    delete window._vtUploadedFile;
                                });
                            }
                            else {
                                window._vtUploadedFile.status = "OK";
                                callback(window._vtUploadedFile);
                                delete window._vtUploadedFile;
                            }
                        }
                        else {
                            window._vtUploadedFile.status = "ERROR";
                            window._vtUploadedFile.error = "Invalid import file format: " + window._vtUploadedFile.type;
                            console.error(window._vtUploadedFile.error);
                            callback(window._vtUploadedFile);
                            delete window._vtUploadedFile;
                        }
                    }
                }
            });
            widget.startup();
            widget.domNode.childNodes[0].click();
        });
    }
    ]]>
        </CodeText>
        <CodeText segment="#doRefresh">
          <![CDATA[
            if (this.renderer.result != null) {
                for (var i=0; i<this.renderer.result.length; i++) {
                    var record = this.renderer.result[i];
                    var value = record["value"];
                    var disable = record["disable"];
                    if (value != null) {
                        if (disable == true || disable == false) {
                            // pay attention ONLY to true or false... ignore other values
                            if (this._menubarItems != null) {
                                var menubarItem = this._menubarItems[value];
                                if (menubarItem != null && menubarItem.widget != null) {
                                    menubarItem.widget.set("disabled", disable == true);
                                }
                            }
                            if (this._toolbarItems != null) {
                                var toolbarItem = this._toolbarItems[value];
                                if (toolbarItem != null && toolbarItem.widget != null) {
                                    toolbarItem.widget.set("disabled", disable == true);
                                }
                            }
                            if (this._sidebaritems != null) {
                                var sidebaritem = this._sidebaritems[value];
                                if (sidebaritem != null && sidebaritem.widget != null) {
                                    sidebaritem.widget.set("disabled", disable == true);
                                }
                            }
                        }
                    }
                }
            }
]]>
        </CodeText>
        <CodeText segment="#onNotify">
          <![CDATA[            if (!evt.model) return;
            
            if (typeof evt.model == "string") {
                this._model = JSON.parse(evt.model);
            } else {
                this._model = evt.model;
            }
            this._drawLayout();]]>
        </CodeText>
        <HtmlText>
          <![CDATA[<div style="width:100%;height:100%;">
</div>
]]>
        </HtmlText>
        <DocText segment="#summary">
          <![CDATA[<p>
MenuBar and ToolBar. Each will take 27px height individually,
but if both are defined, a 1px border between is removed so will only need 53px.
</p>
<p>
Has builtin support for file upload. Browser security prohibits non-UI initiated execution from file upload.
</p>
]]>
        </DocText>
        <DocText segment="#detail">
          <![CDATA[Sample model and corresponding rendering
<table style="width:100%;" cellspacing="5">
    <tr valign="top">
        <td style="font-family:courier;width:100%;">
            <pre>
{
  "menu" : [{
    "label" : "Upload",
    "value" : "upload",
      "items" : [{
        "label" : "Use Local",
        "value" : "#doUploadFile",
        "config" : {
          "mimeTypes" : ["text/plain"],
          "content" : false
        }
      }, {
        "label" : "Use Plugin",
        "value" : "plugin"
      }, {
        "label" : "Use Notify",
        "value" : "notify"
      }, {
        "label" : "Test",
        "value" : "test",
        "items" : []
      }]
  }],
  "toolbar": [{
    "label" : "Combo",
    "value" : "combo"
  }, {
    "label" : "Always On",
    "value" : "always"
  }, {
    "label" : "Upload File",
    "value" : "#doUploadFile"
  }]
}</pre>
        </td>
        <td>
<img src="data:image/png;base64,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"></img>
        </td>
    </tr>
</table>
]]>
        </DocText>
        <SchemaText>
          <![CDATA[var schema = [];
schema.push({ name:"type",  label:"Type",  type:"string", _isDimension:true,  _isMeasure:false });
schema.push({ name:"value", label:"Value", type:"string", _isDimension:true,  _isMeasure:false });
schema.push({ name:"data",  label:"Data",  type:"string", _isDimension:false, _isMeasure:false });
return schema;
]]>
        </SchemaText>
      </Widget>
    </Widgets>
    <Functions>
      <Function name="_escapeHtml" args="text" private="false">
        <CodeText>
          <![CDATA[var html = "";
for (var i=0; i<text.length; i++) {
    var ch = text.charAt(i);
    switch (ch) {
        case "$":
            html += "&dollar;";
            break;
        case "&":
            html += "&amp;";
            break;
        default:
            html += ch;
            break;
    }
}
return html;
]]>
        </CodeText>
      </Function>
      <Function name="_getProjectType" args="type" private="false">
        <CodeText>
          <![CDATA[switch (type) {
    case "sparkm":
        type = "Analytic DataFlow";
        break;
    case "Workbench":
        type = "Workbench Apps";
        break;
    case "qsm":
        type = "ODA Query Service";
        break;
    case "Builder":
        type = "Builder Apps";
        break;
}
return type;
]]>
        </CodeText>
      </Function>
      <Function name="_popup" args="title,msg,items,buttonDef,callback,fieldStyle" private="false">
        <CodeText>
          <![CDATA[// add custom code
var itemStyle = {
    "width" : "100%",
    "font-family": "Arial",
    "border": "1px solid #f8f8f8",
    "border-bottom-color": "#148ac4",
    "height": "26px",
    "line-height": "26px",
    "padding-left": "5px !important",
    "padding-right": "5px !important"
};

if(fieldStyle != null){
    for(var key in fieldStyle)
        itemStyle[key] = fieldStyle[key];
}

items.forEach(function(item, index) {
    item.style = item.style || lang.clone(itemStyle);
    if (item.type == "boolean") {
        delete item.style.width;
        delete item.style.height;
        delete item.style['line-height'];
    }
});

var panelStyle = {
    width: "570px",
    "container" : {
        "background-color" : "white",
    },
    "form-label" : {
        "width" : "10%",
        "white-space" : "nowrap",
    },
    "form-value" : {
        "width" : "90%",
    },
};

prompt(
    title,
    msg,
    items,
    buttonDef,
    panelStyle,
    callback
);]]>
        </CodeText>
      </Function>
      <Function name="_popUserForm" args="user,okCallback,onfail,mode,localization,inputAttributes" private="false">
        <CodeText>
          <![CDATA[var name = undefined;
var password = undefined;
var confirmPassword = undefined;
var fullname = undefined;
var phone = undefined;
var email = undefined;
var isEnabled = true;
var isWorkbenchUser = true;
var isDomainAdmin = undefined;
var isSecurityAdmin = undefined;
var runtimeServers = undefined;
var feedServers = undefined;
var datasources = undefined;
if(user){
    name = user.name;
    fullname = user.fullname;
    phone = user.phone;
    email = user.emails;
    isEnabled = user.isEnabled;
    isWorkbenchUser = user.workbench;
    isDomainAdmin = user.domain;
    isSecurityAdmin = user.security;
    runtimeServers = user.runtime_server_list;
    feedServers = user.feed_server_list;
    datasources = user.datasource_list;
}

var me = this;

var feedServerEnum = [], runtimeServerEnum = [], datasourceEnum = [];

var parameters = {
    op : 'getRuntimeServers',
    detail : false
};
GET('/vitria-oi/rest/server.admin', parameters, function(response){
    if (response != null && response != "") { 
        var answer = JSON.parse(response);
        var status = (answer.result || answer.status || "").toLowerCase();
        if(status == 'ok') {
            runtimeServerEnum = answer.content.servers.map(function(s){
                return {
                    name : s.serverInfo.pool + "/",
                    label : s.serverInfo.name,
                };
            });
            getFeedServerEnum()
            return;
        }
    }
    if(onfail) onfail(parameters, answer.message);
});

function getFeedServerEnum(){
    var parameters = {
        op : 'getFeedServers',
        detail : false
    };
    GET('/vitria-oi/rest/server.admin', parameters, function(response){
        if (response != null && response != "") { 
            var answer = JSON.parse(response);
            var status = (answer.result || answer.status || "").toLowerCase();
            if(status == 'ok') {
                feedServerEnum = answer.content.servers.map(function(s){
                    return {
                        name : s.serverInfo.name,
                        label : s.serverInfo.name,
                    };
                });
                getDatasourceEnum();
                return;
            }
        }
        if(onfail) onfail(parameters, answer.message);
    });
}

function getDatasourceEnum(){
    var parameters = {
        op : 'getDataSources',
        detail : true,
    };
    GET('/vitria-oi/rest/server.admin', parameters, function(response){
        if (response != null && response != "") { 
            var answer = JSON.parse(response);
            var status = (answer.result || answer.status || "").toLowerCase();
            if(status == 'ok') {
                datasourceEnum = answer.content.datasources
                .filter(function(s){
                    return s.datasource.noPersistence == "false";
                })
                .map(function(s){
                    return {
                        name :  s.datasource.jndi,
                        label : s.datasource.name,
                    };
                });
                getPasswordPoliy();
                return;
            }
        }
        if(onfail) onfail(parameters, answer.message);
    });
}

var passwordPolicy = {
    maxLength : "255",
    minLength : "6",
    mandatoryChars : ""
};

function getPasswordPoliy(){
    me.doGetPasswordPolicy(function(policy){
        if(policy){
            passwordPolicy = policy;
            openDialog();
            return;
        }
        if(onfail) onfail(null, "Get Password Policy Fail");
    });
}

function openDialog(){
    var passwordAttribute = {
        minlength : passwordPolicy.minLength,
        maxlength : passwordPolicy.maxLength,
        "class" : 'adminUiInput',
        autocomplete : "new-password" 
    };
    if(passwordPolicy.mandatoryChars != null && passwordPolicy.mandatoryChars != ''){
        passwordAttribute.pattern = '.*[' + passwordPolicy.mandatoryChars.replace(/-/g, '\\-') +']+.*';
    }
    if(mode === 'add') passwordAttribute.required = true
    
    var feedServerListAttributes = {
        "class" : 'adminUiInput',
        required : ''
    };
    var runtimeServerListAttributes = {
        "class" : 'adminUiInput',
        required : ''
    };
    var datasourceListAttributes = {
        "class" : 'adminUiInput',
        required : ''
    };
    if(!isWorkbenchUser){
        feedServerListAttributes.disabled = true;
        runtimeServerListAttributes.disabled = true;
        datasourceListAttributes.disabled = true;
    }
    
    var locale = localization ? localization : {};
    var title = mode == 'add' ? locale['Add User Dialog Title'] : locale['Update Dialog Title'];
    if(title == null) title = "User Account";

    var message = mode == 'add' ? locale['Add User Dialog Message'] : locale['Update User Dialog Message'];
    if(message == null) message = "Please provide information to create user account.";

    var valueMiss = locale['User Dialog Value Miss'] || 'Required';
    var namePatternMismatch = locale['User Dialog Name Mismatch'] || 'Name must start with letters, and only contains letters, digits, - and _';
    var fullNamePatternMismtach = locale['User Dialog Full Name Mismatch'] || 'Full Name must start with letters, and only contains letters, digits, -, _ and spaces';
    var emailInvalid = locale['User Dialog Email Invalid'] || 'Invalid email';
    var phoneInvalid = locale['User Dialog Phone Invalid'] || 'Invalid phone';
    var passwordNotMatch = locale['User Dialog Password Not Match'] || 'Password Not Match';
    var cancel = locale['User Dialog Cancel'] || "Cancel";
    var ok = locale['User Dialog OK'] || "OK";
    var passwordInvalidCharacters = (locale["User Dialog Password Invalid Characters"] || " A password must contain a combination of ") + passwordPolicy.mandatoryChars;
    var passwordTooShort = ( locale['User Dialog Password Too Short'] || "A password's minimal length is " ) + passwordPolicy.minLength
    
    var multiSelectConfig = {
        okClass : 'appDialogSaveButton',
        okLabel : ok,
        cancelLabel : cancel
    };
    
    var isEnabledAttribute =  {
        "class" : 'adminUiInput'
    };
    if(inputAttributes != null){
        if(inputAttributes['isEnabled'] != null){
            for(var k in inputAttributes['isEnabled']) isEnabledAttribute[k] = inputAttributes['isEnabled'][k];
        }
    }
    var items = [   // may be null, in which case, no form UI collected
        {
            name: "name", 
            label: locale['User Dialog Name'] || "Name", 
            type: "string", value: name, disabled: ( mode != 'add' ) ,
            attributes : {
                required : '',
                "class" : 'adminUiInput',
                maxlength : 80,
                pattern : '[a-zA-Z][\\w.-]*',
            },
            errorMessage : {
                valueMissing : valueMiss,
                patternMismatch  : namePatternMismatch
            }
        }, {
            name: "password", 
            label: locale['User Dialog Passwor'] || "Password", 
            type: "password", value: password,
            attributes : passwordAttribute,
            eventHandlers : {
                input : checkPasswordSame
            },
            errorMessage : {
                valueMissing : valueMiss,
                tooShort : passwordTooShort,
                patternMismatch : passwordInvalidCharacters
            }
        }, {
            name: "password2", 
            label: locale["User Dialog Confirm Password"] || "Confirm Password", 
            type: "password", value: password,
            attributes : {
                "class" : 'adminUiInput',
                autocomplete : "new-password" 
            },
            eventHandlers : {
                input : checkPasswordSame
            },
            errorMessage : {
            }
        }, {
            name: "fullname", 
            label: locale['User Dialog Full Name'] || "Full Name", 
            type: "string", value: fullname,
            attributes : {
                "class" : 'adminUiInput',
                maxlength : 80,
                pattern : '[a-zA-Z][ \\w.-]*'
            },
            errorMessage : {
                patternMismatch  : fullNamePatternMismtach
            }
        }, {
            name: "phone", 
            label: locale['User Dialog Phone'] || "Phone", 
            type: "tel", value: phone, 
            attributes : {
                "class" : 'adminUiInput',
                pattern : '[0-9-]+',
            },
            errorMessage : {
                patternMismatch  : phoneInvalid,
            }
        }, {
            name: "emails", 
            label: locale['User Dialog Email'] || "Email", 
            type: "email", value: email, 
            attributes : {
                "class" : 'adminUiInput'
            },

            errorMessage : {
                typeMismatch : emailInvalid
            }
        }, {
            name: "isEnabled", 
            label: locale['User Dialog Active'] || "Active", 
            type: "boolean", value: ( isEnabled == true || isEnabled == "true" ),
            attributes : isEnabledAttribute
        }, {
            name: "workbench", 
            label: locale['User Dialog Workbench'] ||"Workbench User", 
            type: "boolean", value: isWorkbenchUser == true,
            attributes : {
                "class" : 'adminUiInput'
            },
            eventHandlers : {
                change : function(evt){
                    if(evt.target.checked)
                        this.updateForm([
                            {
                                name : 'runtime_server_list',
                                attributes : {
                                    "class" : 'adminUiInput',
                                    "required" : ''
                                },
                            },
                            {
                                name : 'feed_server_list',
                                attributes : {
                                    "class" : 'adminUiInput',
                                    required : ''
                                },
                            },
                            {
                                name : 'datasource_list',
                                attributes : {
                                    "class" : 'adminUiInput',
                                    required : ''
                                },
                            },
                        ]);
                    else
                        this.updateForm([
                            {
                                name : 'runtime_server_list',
                                attributes : {
                                    "class" : 'adminUiInput',
                                    "required" : '',
                                    disabled : true
                                },
                            },
                            {
                                name : 'feed_server_list',
                                attributes : {
                                    "class" : 'adminUiInput',
                                    required : '',
                                    disabled : true
                                },
                            },
                            {
                                name : 'datasource_list',
                                attributes : {
                                    "class" : 'adminUiInput',
                                    required : '',
                                    disabled : true
                                },
                            },
                        ]);
                }
            },
        }, {
            name: "domain", 
            label: locale['User Dialog Domain'] || "Domain Admin", 
            type: "boolean", value: isDomainAdmin == true,
            attributes : {
                "class" : 'adminUiInput'
            }
        }, {
            name: "security", 
            label: locale['User Dialog Security'] || "Security Admin", 
            type: "boolean", value: isSecurityAdmin == true, 
            attributes : {
                "class" : 'adminUiInput'
            }
        }, {
            name: "runtime_server_list", 
            label: locale['User Dialog Runtime Servers'] || "Runtime Servers", 
            type: "multiselect", 
            enums : runtimeServerEnum, 
            value : runtimeServers,
            attributes : runtimeServerListAttributes,
            errorMessage : {
                valueMissing : valueMiss,
            },
            widgetConfig : multiSelectConfig,

        }, {
            name: "feed_server_list", 
            label: locale['User Dialog Feed Servers'] || "Feed Servers", 
            type: "multiselect", enums: feedServerEnum, value: feedServers, 
            attributes : feedServerListAttributes,
            widgetConfig : multiSelectConfig,
            errorMessage : {
                valueMissing : valueMiss,
            }
        }, {
            name: "datasource_list", 
            label: locale['User Dialog Data Sources'] || "Data Sources", 
            type: "multiselect", enums: datasourceEnum, value: datasources,
            attributes : datasourceListAttributes,
            widgetConfig : multiSelectConfig,

            errorMessage : {
                valueMissing : valueMiss,
            }
        },
    ];
    
    var actions = [   // may be null, in which case, default OK/Cancel buttons used
        {label :  locale['User Dialog Save'] || "Save", value : true, 'class' : "appDialogSaveButton", rejectInvalidItem : true },
        {label : cancel, value : false},
    ];
    me._popup(
        title,
        message,
        items,
        actions,
        function(value, info){
            if(info != null) delete info.password2;
            if(value){
                require(["af/utils/XXTEA"], function(XXTEA){
                    if(info.password != '') info.password = XXTEA.encryptM3OData(info.password);
                    okCallback(value, info);
                });
            }else if(info != null){
                delete info.password;
            }
        },
        { // leave space for error message.
            'box-sizing' : 'border-box'
        }
    );

    var checkId = null;
    function checkPasswordSame(evt){
        var form = this;
        window.clearTimeout(checkId);
        checkId = window.setTimeout(function(){
            var password = form.getItem('password').control.value;
            var confirmInput = form.getItem('password2').control;
            var confirm = confirmInput.value;
            if(password === confirm){
                confirmInput.setCustomValidity("");
            }else{
                confirmInput.setCustomValidity(passwordNotMatch);
            }
        }, 300);
    }
}





]]>
        </CodeText>
      </Function>
      <Function name="_popUserGroupForm" args="name,fullname,emails,phone,isDomainAdmin,isSecurityAdmin,okCallback,mode,localization" private="false">
        <CodeText>
          <![CDATA[var locale = localization ? localization : {};
var title = mode == 'add' ? locale['Add Group Dialog Title'] : locale['Update Group Dialog Title'];
if(title == null) title = "User Group";

var message = mode == 'add' ? locale['Add Group Dialog Message'] : locale['Update Group Dialog Message'];
if(message == null) message = "Please provide information to create/update user group.";

var valueMiss = locale['Group Dialog Value Miss'] || 'Required';
var namePatternMismatch = locale['Group Dialog Name Mismatch'] || 'Name must start with letters, and only contains letters, digits, - and _';
var fullNamePatternMismtach = locale['Group Dialog Full Name Mismatch'] || 'Full Name must start with letters, and only contains letters, digits, -, _ and spaces';
var emailInvalid = locale['Group Dialog Email Invalid'] || 'Invalid email';
var phoneInvalid = locale['Group Dialog Phone Invalid'] || 'Invalid phone';

var items = [ 
    {
        name: "name", 
        label: locale['Group Dialog Name'] || "Identifier", 
        type: "string", value: name, disabled: ( mode != 'add' ) , 
        attributes : {
            required : '',
            "class" : 'adminUiInput',
            maxlength : 80,
            pattern : '[a-zA-Z][\\w-]*'
        },
        errorMessage : {
            valueMissing : valueMiss,
            patternMismatch : namePatternMismatch
        },
    }, {
        name: "fullname", 
        label: locale['Group Dialog Full Name'] || "Name", 
        type: "string", value: fullname, disabled: false , 
        attributes : {
            "class" : 'adminUiInput',
            maxlength : 80,
            pattern : '[a-zA-Z][ \\w-]*'
        },
        errorMessage : {
            patternMismatch  : fullNamePatternMismtach
        }
    }, {
        name: "emails", 
        label: locale['Group Dialog Email'] || "Admin Email", 
        type: "email", value: emails, disabled: false,
        attributes : {
            "class" : 'adminUiInput'
        },
        errorMessage : {
            typeMismatch : emailInvalid
        }
    }, {
        name: "phone", 
        label: locale['Group Dialog Phone'] || "Admin Phone", 
        type: "tel", value: phone, disabled: false,
        attributes : {
            "class" : 'adminUiInput',
            pattern : '[0-9-]+',
        },
        errorMessage : {
            patternMismatch  : phoneInvalid
        }
    },
    {
            name: "domain", 
            label: locale['Group Dialog Domain'] || "Domain Admin", 
            type: "boolean", value: isDomainAdmin == true || isDomainAdmin === 'true',
            attributes : {
                "class" : 'adminUiInput'
            }
    }, {
            name: "security", 
            label: locale['Group Dialog Security'] || "Security Admin", 
            type: "boolean", value: isSecurityAdmin == true || isSecurityAdmin === 'true', 
            attributes : {
                "class" : 'adminUiInput'
        }
    }
];
var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: locale['Group Dialog Save'] || "Save", value: true, 'class':"appDialogSaveButton", rejectInvalidItem : true},
    {label: locale['Group Dialog Cancel'] || "Cancel", value: false},
];
this._popup(
    title,
    message,
    items,
    actions,
    okCallback,
    {
            width : 'calc(100% - 15px)', // leave space for error message.
    }
);

]]>
        </CodeText>
      </Function>
      <Function name="deleteUser" args="name,callbacks" private="false">
        <CodeText>
          <![CDATA[    if(name == null) return;
    var onsuccess, onfail;
    if(callbacks){
        onsuccess = callbacks.onsuccess;
        onfail = callbacks.onfail;
    }
    var parameters = {
        op : 'delete',
        format : 'json'
    };
    POST("/vitria-oi/rest/users/"+name, parameters, null, function(t) {
        if (t != null && t != "") {
            var answer = JSON.parse(t);
            var status = (answer.result || answer.status || "").toLowerCase();
            if(status == 'ok'){
                if(onsuccess) onsuccess(name);
                return;
            }
        }
        if(onfail) onfail(name, answer.message);
    });]]>
        </CodeText>
      </Function>
      <Function name="doAddGroupMembers" args="group,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[var me = this;
var locale = localization == null ? {} : localization;
var title = locale['Add Group Member Dialog Title'] || 'Add Member';
var okLabel = locale['Group Dialog OK'] || 'OK';
var cancelLabel = locale['Group Dialog Cancel'] || 'Cancel';

            
me.doListGroupMembers(group.name, function(members){
    popupDialog(function(){
        var selectedMembers = me.picker.getSelected();
        var change = Object.create(group);
        change.add = selectedMembers;
        me.modifyGroup(change, callbacks);    
    }, members);
});

function popupDialog (onSelect, filterList) {
    require([
        "af/components/space/SpaceMemberPicker"
    ], function(SpaceMemberPicker) {
               
        var config = {};
        config.roleConfig = {
            allowAdminRoleAuthoring: true,
            allowGroupAuthoring: true,
            allowGroupInRoleMember: false,
            allowMultipleGroupsInRoleMember: true,
            allowUserAuthoring: true,
            allowUserInRoleMember: true,
            allowWorkbenchRoleAuthoring: true
        };
        me.picker = new SpaceMemberPicker(config);
        
        var selectConfig = {};
        selectConfig.title = title;
        selectConfig.onSelect = onSelect;
        selectConfig.filterList = filterList;
        me.picker.show(selectConfig);
      }); 
}

]]>
        </CodeText>
      </Function>
      <Function name="doAddUser" args="user,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[var onfail = null;
if(callbacks){
    onfail = callbacks.onfail;
}
var me = this;
this._popUserForm(user, function(value, info) {
    if ( value == true ) {
        me.modifyUser(info, 'add', callbacks);
    }
}, onfail, 'add', localization);

]]>
        </CodeText>
      </Function>
      <Function name="doAddUserGroup" args="name,fullname,emails,phone,isDomainAdmin,isSecurityAdmin,onsuccess,onfail,localization" private="false">
        <CodeText>
          <![CDATA[var me = this;
this._popUserGroupForm(name, fullname, emails, phone, isDomainAdmin, isSecurityAdmin, function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        var group = {
            fullname : info.fullname,
            phone : info.phone,
            emails : info.emails,
        };
        var content = {
            group : JSON.stringify(group),
        };
        var parameters = {
            op : 'add',
            format : 'json'
        };
        POST("/vitria-oi/rest/groups/" + info.name, parameters, content, function(t) {
            if (t != null && t != "") { 
                var answer = JSON.parse(t);
                var status = (answer.result || answer.status || "").toLowerCase();
                if(status == 'ok'){
                    updateAdminRole();
                    return;
                }
            }
            if(onfail) onfail(info, answer.message);
        });
    }
    
    function updateAdminRole(){
        var domain = info.domain ? [info.name] : [];
        var security = info.security ? [info.name] : [];
        me.modifyAdminRoles('addAdmin', {
                securityGroups : security,
                domainGroups : domain,
            }, {
                onsuccess : onsuccess,
                onfail : onfail
            });    
        }
    
}, 'add', localization);]]>
        </CodeText>
      </Function>
      <Function name="doAddUserSpaceMembers" args="name,owner,title,type,filter,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var me = this;

function popupDialog (onSelect) {
    
    require([
        "af/components/space/SpaceMemberPicker"
   ], function(SpaceMemberPicker) {
               
        var config = {};
        config.roleConfig = {
            allowAdminRoleAuthoring: true,
            allowGroupAuthoring: true,
            allowGroupInRoleMember: true,
            allowMultipleGroupsInRoleMember: true,
            allowUserAuthoring: true,
            allowUserInRoleMember: true,
            allowWorkbenchRoleAuthoring: true
        };
        me.picker = new SpaceMemberPicker(config);
        
        var selectConfig = {};
        selectConfig.title = title;
        selectConfig.onSelect = onSelect;
        selectConfig.filterList = filter;
        me.picker.show(selectConfig);
  
        
    }); 
    
}

popupDialog(function(){
    var selectedMembers = me.picker.getSelected();
    
    var addedmembers = "";
    for(var i = 0; i < selectedMembers.length; i++){
        if(selectedMembers[0].isuser === true){
            if(type == "admin"){
                addedmembers = "<members><admin><user isuser=\"" + selectedMembers[i].isuser + "\" name=\"" + selectedMembers[i].name + "\" role=\"admin\"></user></admin></members>";
            }else if(type == "contributor"){
                addedmembers = "<members><contributor><user isuser=\"" + selectedMembers[i].isuser + "\" name=\"" + selectedMembers[i].name + "\" role=\"admin\"></user></contributor></members>";
            }else if(type == "viewer"){
                addedmembers = "<members><viewer><user isuser=\"" + selectedMembers[i].isuser + "\" name=\"" + selectedMembers[i].name + "\" role=\"admin\"></user></viewer></members>";
            }
        }else{
            if(type == "admin"){
                addedmembers = "<members><admin><group isuser=\"" + selectedMembers[i].isuser + "\" name=\"" + selectedMembers[i].name + "\" role=\"admin\"></group></admin></members>";
            }else if(type == "contributor"){
                addedmembers = "<members><contributor><group isuser=\"" + selectedMembers[i].isuser + "\" name=\"" + selectedMembers[i].name + "\" role=\"admin\"></group></contributor></members>";
            }else if(type == "viewer"){
                addedmembers = "<members><viewer><group isuser=\"" + selectedMembers[i].isuser + "\" name=\"" + selectedMembers[i].name + "\" role=\"admin\"></group></viewer></members>";
            }    
        }    
        
        var params = {
            addedmembers : addedmembers,
            removedmembers: "<members></members>"
        };
   
        POST("/vitria-oi/rest/spaces/" + name + "?op=updatespace", params, null, function(t) {
            if (t != null && t != "") {
                var status = "";
                var result = "";
                var xl = new XmlList(t);
                status = xl.elements_[0].getAttribute("status");
                result = xl.elements_[0].getAttribute("result");
                callback((status || result).toLowerCase());
                if((status || result).toLowerCase() != "ok"){
                    msg = xl.elements_[0].innerHTML;
                    message(
                        "error",
                        "Alert",
                        status + ":" + msg,
                        function(){
                        }
                    );
                }    
            }
            else {
                callback();
                console.log("The rest api failed to update space members.");
            }
        });
    }    
    
});]]>
        </CodeText>
      </Function>
      <Function name="doCreateUserSpace" args="name,owner,config,locale,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code

var helperPlugin = Plugin(config.helperPluginName);
var self = this;
var items = [ 
    {name: "name", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Name}"), type: "string", value: name, disabled: false,
        attributes : {
            required : '',
            "class" : 'adminUiInput',
            maxlength : 80,
            pattern : '[a-zA-Z][\\s\\w-]*'
        },
        errorMessage : {
            valueMissing : helperPlugin.localize(config.locale.frame, locale, "{i18n::Value Required}"),
            patternMismatch : helperPlugin.localize(config.locale.frame, locale, "{i18n::Pattern Mismatch}"),
        },
    },
    {name: "owner", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Owner}"), type: "string", value: owner, disabled: true},
    {name: "tags", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Tags}"), type: "string", 
        placeholder: helperPlugin.localize(config.locale.frame, locale, "{i18n::Tags Holder}"), disabled: false
    },
    {name: "description", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Description}"), type: "string", 
        placeholder: helperPlugin.localize(config.locale.frame, locale, "{i18n::Des Holder}"), disabled: false
    }
];
var itemStyle = {
    "width" : "calc(100% - 15px)",
    "font-family": "Arial",
    "border": "1px solid #f8f8f8",
    "border-bottom-color": "#148ac4",
    "height": "26px",
    "line-height": "26px",
    "padding-left": "5px !important",
    "padding-right": "5px !important"
};
items.forEach(function(item, index) {
    item.style = itemStyle;
});
var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Ok}"), value: true, "class": "saveButton"},
    {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Cancel}"), value: false},
];

function popupForm(okCallback)
{
    self._popup(
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Space}"),
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Space Prompt}"),
        items,
        actions,
        okCallback
    );
}
    
popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {

        // invoke update DS ( ie: self.dsUpdateUserSpace(info, callback); )
        var params = {
            tags : info.tags,
            description : info.description,
            members : "<members></members>"
        };
        POST("/vitria-oi/rest/spaces/" + info.name + "?op=createspace", params, null, function(t) {
            if (t != null && t != "") {
                var status = "";
                var result = "";
                var xl = new XmlList(t);
                status = xl.elements_[0].getAttribute("status");
                result = xl.elements_[0].getAttribute("result");
                callback((status || result).toLowerCase(), info);
                if((status || result).toLowerCase() != "ok"){
                    msg = xl.elements_[0].innerHTML;
                    message(
                        "error",
                        "Alert",
                        status + ":" + msg,
                        function(){
                        }
                    );
                }
            }
            else {
                callback();
                console.log("The rest api failed to create user space.");
            }
        });
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doDeleteUser" args="user,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[// add custom code
var name = user.name;
var fullname = user.fullname;

var locale = localization ? localization : {};
var title = locale['Delete User Dialog Title'];
if(title == null) title = "User Account";

var message = locale['Delete User Dialog Message'];
if(message == null) message =   "Please confirm user to delete...";

var self = this;
var items = [
    {name: "name", label: locale['User Dialog Name'] || "Identifier",  type: "string", value: name, disabled: true },
    {name: "fullname", label: locale['User Dialog Full Name'] || "Name",  type: "string", value: fullname, disabled: true}
];
var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: locale['User Dialog OK'] || "OK", value: true, 'class' : "appDialogSaveButton",},
    {label: locale['User Dialog Cancel'] || "Cancel", value: false},
];
function popupForm(okCallback)
{
    self._popup(
        title,
        message,
        items,
        actions,
        okCallback
    );
}
    
var me = this;
popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        me.deleteUser(user.name, callbacks)    ;
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doDeleteUserGroup" args="group,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[// add custom code
var name = group.name;
var fullname = group.fullname;

var locale = localization ? localization : {};
if(callbacks){
    var onsuccess = callbacks.onsuccess;
    var onfail = callbacks.onfail;
}

var self = this;
var items = [ 
    {name: "name", label: locale['Group Dialog Name'] || "Identifier",  type: "string", value: name, disabled: true},
    {name: "fullname", label: locale['Group Dialog Full Name'] || "Name", type: "string", value: fullname, disabled: true}, 
];
var actions = [
    {label: locale['Group Dialog Save'] || "Save", value: true},
    {label: locale['Group Dialog Cancel'] || "Cancel", value: false},
];
function popupForm(okCallback)
{
    var title = locale['Delete Group Dialog Title'];
    if(title == null) title = "User Group";

    var message = locale['Delete Group Dialog Message'];
    if(message == null) message =   "Please confirm user group to delete...";
    self._popup(
        title,
        message,
        items,
        actions,
        okCallback 
    );
}
    
var me = this;
popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        var parameters = {
            op : 'delete',
            format : 'json',
            groups : Array.isArray(group) ? group.join(',') : name
        };
        POST("/vitria-oi/rest/groups", parameters, null, function(t) {
            if (t != null && t != "") {
                var answer = JSON.parse(t);
                var status = (answer.result || answer.status || "").toLowerCase();
                if(status == 'ok'){
                    if(onsuccess) onsuccess(group);
                    return;
                }
            }
            if(onfail) onfail(group, answer.message);
        });
    }
});   
   
   
   
   
   
   
   
   


]]>
        </CodeText>
      </Function>
      <Function name="doDeleteUserSpace" args="name,fullname,emails,phone,config,locale,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var helperPlugin = Plugin(config.helperPluginName);
var self = this;
function popupForm(okCallback)
{
    self._popup(
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Space}"),
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Space Delete Message}"),
        [ {name: "name", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Space Identifier}"), type: "string", value: name, disabled: ( name != "" )}],
        [ 
            {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Ok}"), value: true, "class": "saveButton"},
            {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Cancel}"), value: false},
        ],
        okCallback
    );
}

popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        // invoke update DS ( ie: self.dsUpdateUserSpace(info, callback); )
        POST("/vitria-oi/rest/spaces/" + name + "?op=deletespace", null, null, function(t) {
            if (t != null && t != "") {
                var status = "";
                var result = "";
                var xl = new XmlList(t);
                status = xl.elements_[0].getAttribute("status");
                result = xl.elements_[0].getAttribute("result");
                callback((status || result).toLowerCase());
                if((status || result).toLowerCase() != "ok"){
                    msg = xl.elements_[0].innerHTML;
                    message(
                        "error",
                        "Alert",
                        status + ":" + msg,
                        function(){
                        }
                    );
                }
            }
            else {
                callback();
                console.log("The rest api failed to delete user space.");
            }
        });
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doDeleteUserSpaceMembers" args="name,user,isuser,type,config,locale,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var helperPlugin = Plugin(config.helperPluginName);
var self = this;
function popupForm(okCallback)
{
    self._popup(
        helperPlugin.localize(config.locale.frame, locale, "{i18n::Confirm}"),
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Delete Message}"),
        [ {name: "name", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Name}"), type: "string", value: user, disabled: ( user != "" )}],
        [ 
            {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Ok}"), value: true, "class": "saveButton"},
            {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Cancel}"), value: false},
        ],
        okCallback
    );
}

popupForm(function(value, info) {

    if ( value == true ) {

        var removedmembers = "";
        if( isuser === true){
            if(type == "admin"){
                removedmembers = "<members><admin><user isuser=\"" + isuser + "\" name=\"" + user + "\" role=\"admin\"></user></admin></members>";
            }else if(type == "contributor"){
                removedmembers = "<members><contributor><user isuser=\"" + isuser + "\" name=\"" +user + "\" role=\"admin\"></user></contributor></members>";
            }else if(type == "viewer"){
                removedmembers = "<members><viewer><user isuser=\"" + isuser + "\" name=\"" + user + "\" role=\"admin\"></user></viewer></members>";
            }
        }else{
            if(type == "admin"){
                removedmembers = "<members><admin><group isuser=\"" + isuser + "\" name=\"" +user + "\" role=\"admin\"></group></admin></members>";
            }else if(type == "contributor"){
                removedmembers = "<members><contributor><group isuser=\"" + isuser + "\" name=\"" + user + "\" role=\"admin\"></group></contributor></members>";
            }else if(type == "viewer"){
                removedmembers = "<members><viewer><group isuser=\"" + isuser + "\" name=\"" + user + "\" role=\"admin\"></group></viewer></members>";
            }    
        }    
        
        var params = {
            addedmembers : "<members></members>",
            removedmembers: removedmembers
        };
   
        POST("/vitria-oi/rest/spaces/" + name + "?op=updatespace", params, null, function(t) {
            if (t != null && t != "") {
                var status = "";
                var result = "";
                var xl = new XmlList(t);
                status = xl.elements_[0].getAttribute("status");
                result = xl.elements_[0].getAttribute("result");
                callback((status || result).toLowerCase());
                if((status || result).toLowerCase() != "ok"){    
                    msg = xl.elements_[0].innerHTML;
                    message(
                        "error",
                        "Alert",
                        status + ":" + msg,
                        function(){
                        }
                    );
                }
            }
            else {
                callback();
                console.log("The rest api failed to delete user space members.");
            }
        });
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doEnableUser" args="name,enable,callbacks" private="false">
        <CodeText>
          <![CDATA[var onsuccess = null, onfail = null;
if(callbacks){
    onsuccess = callbacks.onsuccess;
    onfail = callbacks.onfail;
}

var parameters = {
    op : enable ? 'enable' : 'disable',
    format : 'json'
};

POST("/vitria-oi/rest/users/" + name, parameters, null, function(t) {
    if (t != null && t != "") { 
        var answer = JSON.parse(t);
        var status = (answer.result || answer.status || "").toLowerCase();
        if(status == 'ok'){
            if(onsuccess) onsuccess(name);
            return;
        }
    }
    if(onfail) onfail(name, answer.message);
});
]]>
        </CodeText>
      </Function>
      <Function name="doExportSecurityLogs" args="callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
require(["af/utils/AppUtil", "af/utils/AppFrame"], function (AppUtil, AppFrame) {
    var filter = {
        pagination: {start: "0", pageSize: "1000000"},
        range: {start: "0", end: "4102444800000"},
        sort: {descend: "false", column: "EVENT_DATE"}
    };
    var params = {
        op: "exportSecurityLog",
        filter: JSON.stringify(filter)
    };
    
    GET("/vitria-oi/rest/security.admin", params, function(t) {
        if (t != null && t != "") {
            var result = JSON.parse(t).result;
            var status = JSON.parse(t).status;
            callback((result || status).toLowerCase());
            if((result || status).toLowerCase() == "ok"){
                var uid = JSON.parse(t).content.securityLogs.uuid;
                var username = AppFrame.getCookie("username");
            
                var downloadURL = AppUtil.getItemURL("/app/dojoclient/user/" + username + "/SecurityLog.csv?op=downloadcsv&uid=" + uid);
                window.open(downloadURL, "_blank");
            }else{
                msg = JSON.parse(t).message;
                message(
                    "error",
                    "Alert",
                    result + ":" + msg,
                    function(){
                    }
                );
            }    
            
        }
        else {
            callback();
            console.log("The rest api failed to export security log data.");
        }
    });

});]]>
        </CodeText>
      </Function>
      <Function name="doGetEncryptionKeys" args="callback" private="false">
        <CodeText>
          <![CDATA[var self = this;

GET("/vitria-oi/rest/security.admin?op=getEncryption", null, function(t) {
    if (t != null && t != "") {
        var result = JSON.parse(t).result;
        var status = JSON.parse(t).status;
        if((result || status).toLowerCase() == "ok"){
            var key = JSON.parse(t).content.encryptionKey;
            callback({
                "uiKey" : self._escapeHtml(key.uiKey),
                "serverKey" : self._escapeHtml(key.serverKey)
            });
        }else{
            msg = JSON.parse(t).message;
            message(
                "error",
                "Alert",
                result || status + ":" + msg,
                function(){
                }
            );
        }        
    }
    else {
        callback(null);
        console.log("The rest api failed to get encryption data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doGetKerberosSetting" args="callback" private="false">
        <CodeText>
          <![CDATA[var self = this;
GET("/vitria-oi/rest/app/event_store/pub/resource?op=getKerberosSecurity&name=kerberosSecurity", null, function(t) {
    if (t != null && t != "") {
        var xl = new XmlList(t);
        var enabled = xl.elements_[0].getAttribute("securityenable");
        var principal = xl.elements_[0].getAttribute("principle");
        var configFile = xl.elements_[0].getAttribute("file");
        var keytabFile = xl.elements_[0].getAttribute("keytab");
        callback({
            "enabled" : enabled,
            "principal" : principal,
            "configFile" : configFile,
            "keytabFile" : keytabFile
        });
    }
    else {
        callback(null);
        console.log("The rest api failed to get kerberos data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doGetLoggingPolicy" args="callback" private="false">
        <CodeText>
          <![CDATA[GET("/vitria-oi/rest/security.admin?op=getPolicy", null, function(t) {
    if (t != null && t != "") {
        var result = JSON.parse(t).result;
        var status = JSON.parse(t).status;
        if((result || status).toLowerCase() == "ok"){
            var policy = JSON.parse(t).content.securityPolicy.logPolicy;
            callback({
                "authentication" : policy.eventType.includes("Authentication"),
                "cryptography" : policy.eventType.includes("Cryptography"),
                "logging" : policy.eventType.includes("Log"),
                "rbac" : policy.eventType.includes("RBAC"),
                "user" : policy.eventType.includes("User"),
            });
        }else{
            msg = JSON.parse(t).message;
            message(
                "error",
                "Alert",
                result || status + ":" + msg,
                function(){
                }
            );
        }
    }
    else {
        callback(null);
        console.log("The rest api failed to get log policy data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doGetLoginPolicy" args="callback" private="false">
        <CodeText>
          <![CDATA[GET("/vitria-oi/rest/security.admin?op=getPolicy", null, function(t) {
    if (t != null && t != "") {
        var result = JSON.parse(t).result;
        var status = JSON.parse(t).status;
        if((result || status).toLowerCase() == "ok"){
            var policy = JSON.parse(t).content.securityPolicy.loginPolicy;
            callback({
                "attemptLimits" : policy.attempt, //5
                "lockDuration" : policy.lockDuration,  //1440
                "tokenInactiveTimeout" : policy.tokenTimer,  //150
                "tokenTotalTimeout" : policy.tokenTotal //-1
            });
        }else{
            msg = JSON.parse(t).message;
            message(
                "error",
                "Alert",
                result || status + ":" + msg,
                function(){
                }
            );
        }
    }
    else {
        callback(null);
        console.log("The rest api failed to get login policy data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doGetNewSpaceOwner" args="callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var owner = "";
require([
    "af/utils/AppFrame"
], function(AppFrame) {
    owner = AppFrame.getUserName();        
});

return owner;]]>
        </CodeText>
      </Function>
      <Function name="doGetPasswordPolicy" args="callback" private="false">
        <CodeText>
          <![CDATA[var self = this;

GET("/vitria-oi/rest/security.admin?op=getPolicy", null, function(t) {
    if (t != null && t != "") {
        var result = JSON.parse(t).result;
        var status = JSON.parse(t).status;
        if((result || status).toLowerCase() == "ok"){
            var policy = JSON.parse(t).content.securityPolicy.pwdPolicy;
            callback({
                "minLength" : policy.minLength,
                "maxLength" : policy.maxLength,
                "mandatoryChars" : self._escapeHtml(policy.mandatoryChars)
            });
        }else{
            msg = JSON.parse(t).message;
            message(
                "error",
                "Alert",
                result || status + ":" + msg,
                function(){
                }
            );
        }
    }
    else {
        callback(null);
        console.log("The rest api failed to get password policy data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doGetSecurityLogs" args="callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var filter = {
    pagination: {start: "0", pageSize: "1000000"},
    range: {start: "0", end: "4102444800000"},
    sort: {descend: "false", column: "EVENT_DATE"},
    //type: "",
    //status: "true"
};
var params = {
    op: "getSecurityLog",
    filter: JSON.stringify(filter)
};    
GET("/vitria-oi/rest/security.admin", params, function(t) {
    if (t != null && t != "") {
        var result = JSON.parse(t).result;
        var status = JSON.parse(t).status;
        if((result || status).toLowerCase() == "ok"){
            var log = JSON.parse(t).content.securityLogs.log;
            callback(log);
        }else{
            callback(null);
            msg = JSON.parse(t).message;
            message(
                "error",
                "Alert",
                result + ":" + msg,
                function(){
                }
            );
        }
    }
    else {
        callback();
        console.log("The rest api failed to get security log data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doGetSpaceInfo" args="name,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
GET("/vitria-oi/rest/spaces/" + name + "?op=getspace", null, function(t) {
    if (t !== null && t !== "") {
        var space = {};
        var xl = new XmlList(t);
        var name = xl.elements_[0].getAttribute("name");
        var owner = xl.elements_[0].getAttribute("owner");
        var tags = xl.elements_[0].getAttribute("tags");
        var description = xl.elements_[0].getAttribute("description");
            
        space = {
            name : name,
            owner : owner,
            tags : tags,
            description : description
        };
        callback(space);
    }
    else {
        callback();
        console.log("The rest api failed to get space info data.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doListAdminRoles" args="onsuccess,onfail" private="false">
        <CodeText>
          <![CDATA[var params = {
    op : 'listAdmin',
    format : 'json'
};
     
GET("/vitria-oi/rest/security?op=listAdmin", params, function(t){
    var answer = JSON.parse(t);
    if(answer.status === 'OK'){
        var admins = answer.value;
        onsuccess(admins);
    }else{
        if(onfail) onfail(answer);
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doListGroupMembers" args="group,callback" private="false">
        <CodeText>
          <![CDATA[GET("/vitria-oi/rest/group?op=listUsersInGroup&group="+group, null, function(t) {
    if (t != null && t != "") {
        var members = [];
        var xl = new XmlList(t);
        xl.elements("content").elements("user").forEach(function(index) {
            members.push({
                name : this.getAttribute("name"),
                fullname : this.getAttribute("fullname"),
                emails : this.getAttribute("emails"),
                isuser : true
            });
        });
        callback(members);
    }
    else {
        callback([]);
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doListGroups" args="callback" private="false">
        <CodeText>
          <![CDATA[var me = this;
GET("/vitria-oi/rest/group?op=listGroups", null, function(t) {
    if (t != null && t != "") {
        var groups = [];
        var xl = new XmlList(t);
        xl.elements("content").elements("group").forEach(function(index) {
            groups.push({
                name : this.getAttribute("name"),
                fullname : this.getAttribute("fullname"),
                emails : this.getAttribute("emails"),
                phone : this.getAttribute("phone"),
            });
        });
   
        me.doListAdminRoles(function(admins){
            groups.forEach(function(g){
                admins.forEach(function(a){
                    if(a.name === g.name && a.type === 'group'){
                        g.domainAdmin = a.domain === 'false' ? false : true;
                        g.securityAdmin = a.security === 'false' ? false : true;
                    }
                });
            });
            if(callback) callback(groups);    
        }, function(message){
            console.error(message);
            if(callback) callback(groups);
        });
    }
    else {
        if(callback) callback([]);
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doListInstallApps" args="callback" private="false">
        <CodeText>
          <![CDATA[GET("/vitria-oi/rest/app.mgr/apps", null, function(t) {
    if (t != null && t != "") {
        var apps = [];
        var xl = new XmlList(t);
        xl.elements("app").forEach(function(index) {
            apps.push({
                id         : this.getAttribute("id"),
                name       : this.getAttribute("title"),
                version    : this.getAttribute("version"),
                modifiedOn : (new Date(Number(this.getAttribute("modified")))).toISOString(),
                modifiedBy : this.getAttribute("modifiedBy"),
                state      : this.getAttribute("state"),
                status     : this.getAttribute("status"),
                removable  : this.getAttribute("removable"),
                licensed   : "unknown",
            });
        });
        callback(apps);
    }
    else {
        callback([]);
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doListRuntimeProjects" args="callback" private="false">
        <CodeText>
          <![CDATA[var self = this;
var params = {
    "op" : "list",
    "format": "json"
};
GET("/vitria-oi/rest/project.mgr", params, function(t) {
    if (t != null && t != "") {
        var projects = [];
        try {
            t = JSON.parse(t);
            if (t.result == "OK") {
                projects = t.content.project;
            }
        } catch (ex) {
        }
        callback(projects);
    }
    else {
        callback([]);
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doListSpaceMembers" args="space,isDomainAdmin,callback" private="false">
        <CodeText>
          <![CDATA[function getBasicUserInfo(users, callback1)
{
    if (users.length == 0) {
        callback1();
    }
    else {
        var user = users.shift();
        var url = "/vitria-oi/rest/users/";
        if(user.isuser == false){
            url = "/vitria-oi/rest/groups/";
        }    
        GET(url + user.name, null, function(t) {
            if (t != null && t != "") {
                var xl = new XmlList(t);
                if(user.isuser == true){
                    xl.elements("user").elements("p").forEach(function(index) {
                        switch (this.getAttribute("name")) {
                            case "fullname":
                                user.fullname = this.textContent;
                                break;
                            case "emails":
                                user.emails = this.textContent;
                                break;
                            case "phones":
                                user.phones = this.textContent;
                                break;
                        }
                    });
                }else{
                    xl.elements("content").elements("group").forEach(function(index){
                        user.fullname = this.getAttribute("fullname");
                        user.emails = this.getAttribute("emails");
                        user.phones = this.getAttribute("phone");
                    });
                }    
            }
            getBasicUserInfo(users, callback1)
        });
    }
}

GET("/vitria-oi/rest/spaces/"+space+"?op=getspace", null, function(t) {
    if (t != null && t != "") {
        var administrators = [];
        var contributors = [];
        var viewers = [];
        var xl = new XmlList(t);
        xl.elements("members").elements("admin").elements("user").forEach(function(index) {
            administrators.push({
                name     : this.getAttribute("name"),
                fullname : "",
                emails   : "",
                phones   : "",
                isuser   : true
            });
        });
        xl.elements("members").elements("admin").elements("group").forEach(function(index) {
            administrators.push({
                name     : this.getAttribute("name"),
                fullname : "",
                emails   : "",
                phones   : "",
                isuser   : false
            });
        });
        xl.elements("members").elements("contributor").elements("user").forEach(function(index) {
            contributors.push({
                name     : this.getAttribute("name"),
                fullname : "",
                emails   : "",
                phones   : "",
                isuser   : true
            });
        });
        xl.elements("members").elements("contributor").elements("group").forEach(function(index) {
            contributors.push({
                name     : this.getAttribute("name"),
                fullname : "",
                emails   : "",
                phones   : "",
                isuser   : false
            });
        });
        xl.elements("members").elements("viewer").elements("user").forEach(function(index) {
            viewers.push({
                name     : this.getAttribute("name"),
                fullname : "",
                emails   : "",
                phones   : "",
                isuser   : true
            });
        });
        xl.elements("members").elements("viewer").elements("group").forEach(function(index) {
            viewers.push({
                name     : this.getAttribute("name"),
                fullname : "",
                emails   : "",
                phones   : "",
                isuser   : false
            });
        });
        if (isDomainAdmin) {
            var users = [].concat(administrators, contributors, viewers);
            getBasicUserInfo(users, function() {
                callback({
                    administrators : administrators,
                    contributors  : contributors,
                    viewers       : viewers,
                });
            });
        }
        else {
            callback({
                administrators : administrators,
                contributors  : contributors,
                viewers       : viewers,
            });
        }
    }
    else {
        callback(null);
        console.log("The rest api failed to get space member data.");
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doListSpaces" args="callback" private="false">
        <CodeText>
          <![CDATA[GET("/vitria-oi/rest/spaces?op=getaccessiblespacelist", null, function(t) {
    if (t != null && t != "") {
        var spaces = [];
        var xl = new XmlList(t);
        xl.elements("space").forEach(function(index) {
            var name = this.getAttribute("name");
            var label = name;
            switch (name) {
                case "private":
                    label = "* Personal";
                    break;
                case "public":
                    label = "* Public";
                    break;
            }

            spaces.push({
                name  : name,
                label : label,
            });
        });
        callback(spaces);
    }
    else {
        callback(null);
        console.log("The rest api failed to get user space data.");
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doListUsers" args="callback" private="false">
        <CodeText>
          <![CDATA[var me = this;
GET("/vitria-oi/rest/users?op=get&format=json", null, function(t) {
    if (t != null && t != "") {
        var answer = JSON.parse(t);
        if(answer.status === 'OK'){
            var users = answer.content.user;
            users.forEach(function(u){
                u.type = u.workbench ? 'Workbench' : 'Application';
            });
            
            me.doListAdminRoles(function(admins){
                users.forEach(function(u){
                    admins.forEach(function(a){
                        if(a.name === u.name && a.type === 'user'){
                            u.domainAdmin = a.domain === 'false' ? false : true;
                            u.securityAdmin = a.security === 'false' ? false : true;
                        }
                    });
                });
                if(callback) callback(users);
            }, function(message){
                console.error(message);
                if(callback) callback(users);
            });
        }
    } else {
        if(callback) callback([]);
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doPurgeSecurityLogs" args="callback" private="false">
        <CodeText>
          <![CDATA[// add custom code

function popupForm(okCallback)
{
    require(["af/controls/AppDialog", "af/components/form/InternalDateTextBox", "dojo/dom-construct"], function (Dialog, InternalDateTextBox, construct) {
        var me = this;

		function onSave() {
            if (me.popDialog) {
                okCallback(true, me._widget.dtDate);
                me.popDialog.hide();
                me.popDialog = null;
            }
		};

		function onCancel() {
            if (me.popDialog) {
                me.popDialog.hide();
                me.popDialog = null;
            }
		};
        
        
        var dialog = new Dialog({
            title : "Purge Security Log",
            okHandler: onSave,
            cancelHandler: onCancel
		});
		var div = construct.create("div");
		var labelDiv = construct.create("div", {
		    style: "padding: 10px 10px 0px 10px;"
		});
		labelDiv.innerHTML = "Remove log entries older than";
		dialog.containerNode.appendChild(labelDiv);
		dialog.containerNode.appendChild(div);
	
		this.popDialog = dialog;
		this._widget = new InternalDateTextBox({
		    constraints : {
		        datePattern: "yyyy-MM-dd",
                selector: "date"
                },
		    label : "Date",
		    orientation: "vertical",
		    style: "padding: 10px;"
		}, div);

		this.popDialog.show();
    });
}

popupForm(function(value, date) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {

        var date = new Date(date);
        var params = {
            op: "purgeSecurityLog",
            before: String(date.getTime())
        };    
        POST("/vitria-oi/rest/security.admin", params, null, function(t) {
            if (t != null && t != "") {
                
                var result = JSON.parse(t).result;
                var status = JSON.parse(t).status;
                callback((result || status).toLowerCase());
                
                if((result || status).toLowerCase() != "ok"){
            
                    msg = JSON.parse(t).message;
                    message(
                        "error",
                        "Alert",
                        result + ":" + msg,
                        function(){
                        }
                    );
                }
            }
            else {
                callback();
                console.log("The rest api failed to purge security log.");
            }
        });
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doRemoveGroupMembers" args="group,members,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[var me = this;
var locale = localization == null ? {} : localization;
var title = locale['Remove Member Dialog Title'] || 'Remove Members';
var confirmTitle = locale['Confirm Remove Member Dialog Title'] || 'User Group';
var confirmMessage = locale['Confirm Remove Mmeber Dialog Message'] || 'Please confirm members to remove:';
var okLabel = locale['Group Dialog OK'] || 'OK';
var cancelLabel = locale['Group Dialog Cancel'] || 'Cancel';



var self = this;
var items = [ 
    {
        name: "name", 
        label: locale['Group Member Dialog Name'] || "Identifier", 
        type: "label", value: members.join(', '), disabled: true , style: {
            "width" : "291px",
            "font-family": "Arial",
            "border": "1px solid #f8f8f8",
            "border-bottom-color": "#148ac4",
            "line-height" : "26px",
            "display" : "block",
            "overflow-y" : "auto",
            "overflow-x" : "hidden",
            "max-height" : "50px",
            "background-color" : 'rgb(235, 235, 228)'
        },
        attributes : {
            "class" : "adminUiInput"
        }
    },
];

var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: locale['Group Dialog OK'] || "OK", value: true, 'class' : "appDialogSaveButton",},
    {label: locale['Group Dialog Cancel'] || "Cancel", value: false},
];

openConfirmDialog(members.join(', '), function(confirm){
    if(confirm){
        var change = Object.create(group);
            change.remove = members.map(function(v){ 
                return { name : v }; 
            });
        me.modifyGroup(change, callbacks);  
    }
});

function openConfirmDialog(names, okCallback){
    self._popup(
        confirmTitle,
        confirmMessage,
        items,
        actions,
        okCallback
    );
}
]]>
        </CodeText>
      </Function>
      <Function name="doRemoveUserGroup" args="group,callbacks" private="false">
        <CodeText>
          <![CDATA[// add custom code]]>
        </CodeText>
      </Function>
      <Function name="doRemoveUserSpace" args="" private="false">
        <CodeText>
          <![CDATA[// add custom code]]>
        </CodeText>
      </Function>
      <Function name="doRemoveUserSpaceMembers" args="" private="false">
        <CodeText>
          <![CDATA[// add custom code]]>
        </CodeText>
      </Function>
      <Function name="doSaveEncryptionKeys" args="key,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
require(["af/utils/XXTEA"], function (XXTEA) {

    key.uiKey = XXTEA.encryptM3OData(key.uiKey, "");
    key.serverKey = XXTEA.encryptM3OData(key.serverKey, "");
    var keyForm = {
            encryptionKey: key
        };

    var params = {
            op: "saveEncryption"
        };
    var headers = {
            encryption: JSON.stringify(keyForm)
        };    
    POST("/vitria-oi/rest/security.admin?op=saveEncryption", params, headers, function(t){
        if(t != null){
            var result = JSON.parse(t).result;
            var status = JSON.parse(t).status;
            callback((result || status).toLowerCase());
            if((result || status).toLowerCase() != "ok"){
                msg = JSON.parse(t).message;
                message(
                    "error",
                    "Alert",
                    result + ":" + msg,
                    function(){
                    }
                );
            }
        }else{
            callback(null);
            console.log("The rest api failed to save encryption keys.");
        }    
    });
});    ]]>
        </CodeText>
      </Function>
      <Function name="doSaveKerberosSetting" args="policy,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var params = {
    op: "updateKerberosSecurity",
    name: "kerberosSecurity"
};
var date = new Date();
var headers = {
    securityenable: String(policy.enabled),
    file: policy.configFile,
    principle: policy.principal,
    keytab: policy.keytabFile,
    configuration: '<configuration/>',
    _format: '0',
    _method: '1',
    _params: 'principle;keytab;file;configuration;securityenable',
    _url: '/app/event_store/pub/resource?&name=kerberosSecurity&op=updateKerberosSecurity&nocache=' + date.getTime()
}    
POST("/vitria-oi/rest/app/event_store/pub/resource", params, headers, function(t){
    if(t != null){
        var status = "";
        var xl = new XmlList(t);
        status = xl.elements_[0].getAttribute("value");
        callback(status);
        if(status.toLowerCase() != "ok"){
            msg = xl.elements("message").elements_[0].innerHTML;
            message(
                "error",
                "Alert",
                status + ":" + msg,
                function(){
                }
            );
        }
    } else {
        callback(null);
        console.log("The rest api failed to save kerberos setting.");
    }    
});]]>
        </CodeText>
      </Function>
      <Function name="doSaveLoggingPolicy" args="logPolicy,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
GET("/vitria-oi/rest/security.admin?op=getPolicy", null, function(t) {
    if (t != null && t != "") {
        var policy = JSON.parse(t);
        policy.content.securityPolicy.logPolicy = logPolicy;
        var params = {
            op: "savePolicy",
            format: "json"
        };
        var headers = {
            policy: JSON.stringify(policy.content)
        };
        POST("/vitria-oi/rest/security.admin", params, headers, function(t2){
            if(t2 != null){
                var result = JSON.parse(t2).result;
                var status = JSON.parse(t2).status;
                callback((result || status).toLowerCase());
                if((result || status).toLowerCase() != "ok"){
                    msg = JSON.parse(t2).message;
                    message(
                        "error",
                        "Alert",
                        result + ":" + msg,
                        function(){
                        }
                    );
                }
            }    
        });
    }
    else {
        callback();
        console.log("The rest api failed to save log policy setting.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doSaveLoginPolicy" args="loginPolicy,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
GET("/vitria-oi/rest/security.admin?op=getPolicy", null, function(t) {
    if (t != null && t != "") {
        var policy = JSON.parse(t);
        policy.content.securityPolicy.loginPolicy = loginPolicy;
        var params = {
            op: "savePolicy",
            format: "json"
        };
        var headers = {
            policy: JSON.stringify(policy.content)
        };
        
        POST("/vitria-oi/rest/security.admin", params, headers, function(t2){
            if(t2 != null){
                var result = JSON.parse(t2).result;
                var status = JSON.parse(t2).status;
                callback((result || status).toLowerCase());
                if((result || status).toLowerCase() != "ok"){
                    msg = JSON.parse(t2).message;
                    message(
                        "error",
                        "Alert",
                        result + ":" + msg,
                        function(){
                        }
                    );
                }
            }    
        });
    }
    else {
        callback();
        console.log("The rest api failed to save login policy setting.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doSavePasswordPolicy" args="passwordPolicy,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
GET("/vitria-oi/rest/security.admin?op=getPolicy", null, function(t) {
    if (t != null && t != "") {
        var policy = JSON.parse(t);
        policy.content.securityPolicy.pwdPolicy = passwordPolicy;
        var params = {
            op: "savePolicy",
            format: "json"
        };
        var headers = {
            policy: JSON.stringify(policy.content)
        };
        POST("/vitria-oi/rest/security.admin", params, headers, function(t2){
            if(t2 != null){
                var result = JSON.parse(t2).result;
                var status = JSON.parse(t2).status;
                callback((result || status).toLowerCase());
                if((result || status).toLowerCase() != "ok"){
                    msg = JSON.parse(t2).message;
                    message(
                        "error",
                        "Alert",
                        result + ":" + msg,
                        function(){
                        }
                    );
                }
            }    
        });
    }
    else {
        callback();
        console.log("The rest api failed to save password policy setting.");
    }
});]]>
        </CodeText>
      </Function>
      <Function name="doUnlockUser" args="user,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[// add custom code
var name = user.name;
var fullname = user.fullname;

var locale = localization ? localization : {};
var title = locale['Unlock User Dialog Title'];
if(title == null) title = "User Account";

var message = locale['Unlock User Dialog Message'];
if(message == null) message =   "Please confirm user to unlock...";

var self = this;
var items = [ 
    {name: "name", label: locale['User Dialog Name'] || "Identifier", type: "string", value: name, disabled: true },
    {name: "fullname", label: locale['User Dialog Full Name'] || "Name", type: "string", value: fullname, disabled: true }
];
var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: locale['User Dialog OK'] || "OK", value: true, 'class' : "appDialogSaveButton"},
    {label: locale['User Dialog Cancel'] || "Cancel", value: false},
];

function popupForm(okCallback) {
    self._popup(
        title,
        message,
        items,
        actions,
        okCallback
    );
}
    

var me = this;
popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        me.unlockUsers([ user.name ], callbacks)    ;
    }
});
]]>
        </CodeText>
      </Function>
      <Function name="doUnlockUserGroup" args="group,callbacks,localization" private="false">
        <CodeText>
          <![CDATA[// add custom code
var name = group.name;
var fullname = group.fullname;

var locale = localization ? localization : {};
var self = this;
var items = [ 
    {name: "name", label: locale['Group Dialog Name'] || "Identifier", type: "string", value: name, disabled: true },
    {name: "fullname", label: locale['Group Dialog Full Name'] || "Name", type: "string", value: fullname, disabled: true }
];
var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: locale['Group Dialog Save'] || "Save", value: true},
    {label: locale['Group Dialog Cancel'] || "Cancel", value: false},
];
function popupForm(okCallback)
{
    var title = locale['Unlock Group Dialog Title'];
    if(title == null) title = "User Group";

    var message = locale['Unlock Group Dialog Message'];
    if(message == null) message =   "Please confirm user group to unlock...";
    self._popup(
        title,
        message,
        items,
        actions,
        okCallback 
    );
}
    

var me = this;
popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        me.doListGroupMembers(name, function(members){
            var names = members.map(function(m){
                return m.name;
            });
            me.unlockUsers(names, callbacks);
        });
    }
});

]]>
        </CodeText>
      </Function>
      <Function name="doUpdateUser" args="user,callbacks,localization,inputAttributes" private="false">
        <CodeText>
          <![CDATA[var onfail = null;
if(callbacks){
    onfail = callbacks.onfail;
}
var mode = 'modify'
var me = this;
this._popUserForm(user, function(value, info) {
    if ( value == true ) {
        var newInfo = {};
        for(var key in info){
            if(info[key] === user[key]) continue;
            else if(info[key] === '' && user[key] == null) continue;
            else if(Array.isArray(info[key]) && info[key].join(',') === user[key]) continue;
            else if(user[key] != null && info[key].toString() === user[key].toString()) continue;
            newInfo[key] = info[key];
        }
        newInfo.name = info.name;
        if(Object.keys(newInfo).length === 2 && 'isEnabled' in newInfo){
            me.doEnableUser(newInfo.name, newInfo.isEnabled, callbacks);
        }else{
            if(!('isEnabled' in newInfo)) delete info.isEnabled;
            me.modifyUser(info, mode, callbacks);
        }
    }
}, onfail, mode, localization, inputAttributes);

]]>
        </CodeText>
      </Function>
      <Function name="doUpdateUserGroup" args="name,fullname,emails,phone,isDomainAdmin,isSecurityAdmin,onsuccess,onfail,localization" private="false">
        <CodeText>
          <![CDATA[var me = this;
this._popUserGroupForm(name, fullname, emails, phone, isDomainAdmin, isSecurityAdmin,  function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {
        var group = {
            fullname : info.fullname,
            phone : info.phone,
            emails : info.emails,
            name : info.name,
            security : info.security,
            domain : info.domain
        };
        
        me.modifyGroup(group, {
            onsuccess : function(){
                var callbacks = {
                    onsuccess : onsuccess,
                    onfail : onfail,
                };
                if(isDomainAdmin !== info.domain){
                    me.modifyAdminRoles(info.domain ? 'addAdmin' : 'deleteAdmin', { domainGroups : [info.name] }, callbacks);
                }
                if(isSecurityAdmin !== info.security){
                    me.modifyAdminRoles(info.security ? 'addAdmin' : 'deleteAdmin', { securityGroups : [info.name] }, callbacks);
                }
            },
           onfail : onfail,
        });
    }
}, 'update', localization);]]>
        </CodeText>
      </Function>
      <Function name="doUpdateUserSpace" args="name,owner,tags,description,config,locale,callback" private="false">
        <CodeText>
          <![CDATA[// add custom code
var helperPlugin = Plugin(config.helperPluginName);
var self = this;
var items = [ 
    {name: "name", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Name}"), type: "string", value: name, disabled: false,
        attributes : {
            required : '',
            "class" : 'adminUiInput',
            maxlength : 80,
            pattern : '[a-zA-Z][\\w-]*'
        },
        errorMessage : {
            valueMissing : helperPlugin.localize(config.locale.frame, locale, "{i18n::Value Required}"),
            patternMismatch : helperPlugin.localize(config.locale.frame, locale, "{i18n::Pattern Mismatch}"),
        },
    },
    {name: "owner", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Owner}"), type: "string", value: owner, disabled: true},
    {name: "tags", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Tags}"), type: "string", value: tags, disabled: false},
    {name: "description", label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Description}"), type: "string", value: description, disabled: false},
];
var actions = [   // may be null, in which case, default OK/Cancel buttons used
    {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Ok}"), value: true, "class": "saveButton"},
    {label: helperPlugin.localize(config.locale.frame, locale, "{i18n::Cancel}"), value: false},
];
function popupForm(okCallback) {
    self._popup(
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Space}"),
        helperPlugin.localize(config.locale.frame, locale, "{i18n::User Space Prompt}"),
        items,
        actions,
        okCallback
    );
}

popupForm(function(value, info) {
    // value is value of button clicked
    // data is form data
    if ( value == true ) {

        // invoke update DS ( ie: self.dsUpdateUserSpace(info, callback); )
        var params = {
            newtags : info.tags,
            newdescription : info.description,
            addedmembers : "<members></members>",
            removedmembers: "<members></members>"
        };
        if(info.name != name) {
            params["newspacename"] = info.name;
        }    
        POST("/vitria-oi/rest/spaces/" + name + "?op=updatespace", params, null, function(t) {
            if (t != null && t != "") {
                var status = "";
                var result = "";
                var xl = new XmlList(t);
                status = xl.elements_[0].getAttribute("status");
                result = xl.elements_[0].getAttribute("result");
                callback((status || result).toLowerCase(), info);
                if((status || result).toLowerCase() != "ok"){
                    msg = xl.elements_[0].innerHTML;
                    message(
                        "error",
                        "Alert",
                        status + ":" + msg,
                        function(){
                        }
                    );
                }
            }
            else {
                callback();
                console.log("The rest api failed to update user space.");
            }
        });
    }
});]]>
        </CodeText>
      </Function>
      <Function name="modifyAdminRoles" args="operation,content,callbacks" private="false">
        <CodeText>
          <![CDATA[if(operation !== 'deleteAdmin' && operation !== 'addAdmin') return;
var parameters = {
    op : operation,
    format : 'json'
};

var body = {
    securityUsers : content.securityUsers == null ? "" : content.securityUsers.join(','),
    securityGroups : content.securityGroups == null ? "" : content.securityGroups.join(','),
    domainUsers : content.domainUsers == null ? "" : content.domainUsers.join(','),
    domainGroups : content.domainGroups == null ? "" : content.domainGroups.join(',')
};

var onsuccess, onfail;
if(callbacks != null){
    onsuccess = callbacks.onsuccess;
    onfail = callbacks.onfail;
}

if(body.securityUsers.length == 0 && body.securityGroups.length == 0 && body.domainUsers.length == 0 && body.domainGroups.length == 0){
    if(onsuccess != null) onsuccess();
    return;
}

POST('/vitria-oi/rest/security', parameters, body, function(t){
    if(t != null){
        var answer = JSON.parse(t);
        if(answer.result === 'OK' && onsuccess != null){
            onsuccess();
            return;
        }
        if(onfail != null) onfail();
    }
});]]>
        </CodeText>
      </Function>
      <Function name="modifyGroup" args="group,callbacks" private="false">
        <CodeText>
          <![CDATA[if(callbacks){
    var onsuccess = callbacks.onsuccess;
    var onfail = callbacks.onfail;
}
var content = {
    group : JSON.stringify(group),
};
var parameters = {
    op : 'modify',
    format : 'json'
};

POST("/vitria-oi/rest/groups/" + group.name, parameters, content, function(t) {
    if (t != null && t != "") { 
        var answer = JSON.parse(t);
        if(answer.result == 'OK') {
            if(onsuccess) onsuccess(group);
            return;
        }
    }
    if(onfail) onfail(group, answer.message);
});]]>
        </CodeText>
      </Function>
      <Function name="modifyUser" args="info,operation,callbacks" private="false">
        <CodeText>
          <![CDATA[var xmlContent = '<user security="false" domain="false" workbench="false"> \
            <p name="fullname"></p> \
            <p name="phone"></p> \
            <p name="emails"></p> ' +
            ( info.password == '' ? '' : '<p name="password"></p> ' ) + 
            '<p name="feed_server_list"></p> \
            <p name="runtime_server_list"></p> \
            <p name="datasource_list"></p> \
            </user>';
var onsuccess = null, onfail = null;
if(callbacks){
    onsuccess = callbacks.onsuccess;
    onfail = callbacks.onfail;
}
var parser = new DOMParser();
var xmlDoc = parser.parseFromString(xmlContent, 'text/xml');

var userNode = xmlDoc.querySelector('user');
if (userNode.getAttributeNames == undefined) {
  userNode.getAttributeNames = function () {
    var attributes = this.attributes;
    var length = attributes.length;
    var result = new Array(length);
    for (var i = 0; i < length; i++) {
      result[i] = attributes[i].name;
    }
    return result;
  };
}
userNode.getAttributeNames().forEach(function(attr){
    if(attr in info) userNode.setAttribute(attr, info[attr]);
});

var pNodes = [].slice.call(xmlDoc.querySelectorAll('p'));
pNodes.forEach(function(pNode){
    var name = pNode.getAttribute('name');
    if(name in info)
        pNode.textContent = Array.isArray(info[name]) ? info[name].join(',') : info[name];
    else
        pNode.parentNode.removeChild(pNode);
});


var content = {
    user : new XMLSerializer().serializeToString(xmlDoc),
};
var parameters = {
    op : operation,
    format : 'json'
};

var me = this;

var enableUserCall = this.doEnableUser.bind(this, info.name, info.isEnabled, {
                    onsuccess : function(){
                        if(onsuccess) onsuccess(info);
                    },
                    onfail : function(name, message){
                        var title = (operation == 'enable')
                            ? 'Enable User Fail' 
                            : 'Disable User Fail';
                        me.popAlert(title, message);
                    },
                });


var needEnable = 'isEnabled' in info;
var needModify = xmlDoc.querySelector('p') || userNode.getAttributeNames().length > 0;
if(needModify){
    POST("/vitria-oi/rest/users/" + info.name, parameters, content, function(t) {
        if (t != null && t != "") { 
            var answer = JSON.parse(t);
            if(answer.result == 'OK'){
                if(needEnable){
                    enableUserCall();
                }else{
                    if(onsuccess) onsuccess(info);
                }
                return;
            }
        }
        if(onfail) onfail(info, answer.message);
    }); 
}else if(needEnable){
    enableUserCall();
}else{
    if(onsuccess) onsuccess(info);
}


]]>
        </CodeText>
      </Function>
      <Function name="popAlert" args="title,message,buttons,style" private="false">
        <CodeText>
          <![CDATA[if(buttons == null)
    buttons = [{
        label : 'OK'
    }];
var promptButtons = buttons.map(function(b){
    return {
        label : b.label,
        value : b.label
    }
});
prompt(
    title,
    message,
    [],
    promptButtons,
    style == null ? {
    } : style,
    function(value){
        buttons.forEach(function(b){
            if(b.label === value && b.callback)
                b.callback();
        });
    }
);

]]>
        </CodeText>
      </Function>
      <Function name="unlockUsers" args="names,callbacks" private="false">
        <CodeText>
          <![CDATA[var onsuccess, onfail;
if(callbacks){
    onsuccess = callbacks.onsuccess;
    onfail = callbacks.onfail;
}
var parameters = {
    op : 'unlock',
    users : names.join(','),
    format : 'json'
};

POST('/vitria-oi/rest/users', parameters, null, function(t){
       if (t != null && t != "") { 
        var answer = JSON.parse(t);
        if(answer.result == 'OK'){
            if(onsuccess) onsuccess();
            return;
        }
    }
    if(onfail) onfail(names, answer.message);

});
        
]]>
        </CodeText>
      </Function>
    </Functions>
    <Services>
      <Service name="dsHasDataSources" args="jndiNames" private="false">
        <CodeText>
          <![CDATA[if (typeof jndiNames == "string") {
    jndiNames = JSON.parse(jndiNames);
}
var exists = {};
for (var i=0; i<jndiNames.length; i++) {
    exists[jndiNames[i]] = false;
}
var VirtualServerLib = com.vitria.m3oui.virtualserver.VirtualServerLib;
var dslist = VirtualServerLib.listAllDataSources();
if (dslist != null && dslist.size() > 0) {
    for (var i = 0; i < dslist.size(); i++) {
        var model = dslist.get(i);
        var jndiName = model.getProperty("jndi");
        if (exists[jndiName] != null) {
            exists[jndiName] = true;
        }
    }
}
return exists;
]]>
        </CodeText>
      </Service>
      <Service name="dsListDataSources" args="" private="false">
        <CodeText>
          <![CDATA[var DomainServiceClient = com.vitria.domainservice.DomainServiceClient;
var dsMap = DomainServiceClient.getClient().listAllDataSources();
var dsList = [];
if (dsMap != null && dsMap.size() > 0) {
    var iter = dsMap.entrySet().iterator();
    while (iter.hasNext()) {
		var entry = iter.next();
        var ds = entry.getValue();
        
        var desc = ds.getDescription() || "";
        var url = ds.getUrl() || ds.getConnectionUrl() || "";
        dsList.push({
            "jndiName" : ds.getJndiName(),
            "name" : ds.getName(),
            "behavior" : ds.getBehavior(),
            "username" : ds.getUsername(),
            "password" : ds.getPassword(),
            "class" : ds.getDataSourceClass(),
            "url" : url,
            "desc" : desc,
        });
    }
}
return dsList;
]]>
        </CodeText>
      </Service>
      <Service name="dsRemoveDataSource" args="name" private="false">
        <CodeText>
          <![CDATA[var JNDI_PREFIX = "/vitria/m3o/datasource/DefaultDomain/";
var VirtualServerLib = com.vitria.m3oui.virtualserver.VirtualServerLib;

if (dsHasDataSources([JNDI_PREFIX + name])[JNDI_PREFIX + name]) {
    VirtualServerLib.removeDataSource(JNDI_PREFIX + name);
    return {
        "action" : "deleted",
        "message" : "Data source '" + JNDI_PREFIX + name + "' deleted.",
    };
}
return false;]]>
        </CodeText>
      </Service>
      <Service name="dsUpdateDataSource" args="info" private="false">
        <CodeText>
          <![CDATA[if (typeof info == "string") {
    info = JSON.parse(info);
}
var name = info["name"];
var url = info["url"];
var username = info["username"];
var password = info["password"];
var driver = info["driver"];
var xaclass = info["xaclass"];
var dsclass = info["dsclass"];
var behavior = info["behavior"];
var desc = info["desc"];
var server = null;
var port = null;
var database = null;

// expect jdbc:behavior://server:port/database
var toks = url.split(":");
if (toks.length == 4) {
    // toks[2] == //server
    // toks[3] == port/database
	server = (toks[2]).substring(2);
	var slash = (toks[3]).indexOf('/');
	port = (toks[3]).substring(0, slash);
	database = (toks[3]).substring(slash+1);
}

var Encrypt = com.vitria.fc.data.Encrypt;
password = Encrypt.unencrypt(password.trim());

var JNDI_PREFIX = "/vitria/m3o/datasource/DefaultDomain/";

var DataSourceInfo = com.vitria.domainservice.DataSourceInfo;
var ds = new DataSourceInfo();
ds.setBehavior(behavior);
ds.setUsername(username);
ds.setPassword(password);
ds.setName(name);
ds.setJndiName(JNDI_PREFIX + name);
ds.setNotUsedByProjectPersistence(true);

if (behavior.toLowerCase() == "oracle" || behavior.toLowerCase() == "mysql" || behavior.toLowerCase() == "mysql") {
    ds.setServer(server);
    ds.setPort(parseInt(port));
    ds.setDatabase(database);
}
else {
    ds.setUrl(url);
}

if (driver != null && driver != "")
    ds.setDriver(driver);
if (xaclass != null && xaclass != "")
    ds.setXaDataSourceClass(xaclass);
if (dsclass != null && dsclass != "")
    ds.setDataSourceClass(dsclass);
if (desc != null && desc != "")
    ds.setDescription(desc);

var VirtualServerLib = com.vitria.m3oui.virtualserver.VirtualServerLib;

if (dsHasDataSources([JNDI_PREFIX + name])[JNDI_PREFIX + name]) {
    VirtualServerLib.updateDataSource(ds);
    return {
        "action" : "created",
        "message" : "Data source '" + JNDI_PREFIX + name + "' updated.",
    };
}
else {
    VirtualServerLib.addDataSource(ds);
    return {
        "action" : "updated",
        "message" : "Data source '" + JNDI_PREFIX + name + "' created.",
    };
}
]]>
        </CodeText>
      </Service>
      <Service name="isDomainAdmin" args="" private="false">
        <CodeText>
          <![CDATA[var SUMLib = com.vitria.m3oui.sum.SUMLib;
return SUMLib.isDomainAdmin(Context.getCurrentUserId());]]>
        </CodeText>
      </Service>
      <Service name="svListServers" args="" private="false">
        <CodeText>
          <![CDATA[var VirtualServerLib = com.vitria.m3oui.virtualserver.VirtualServerLib;
var VirtualServerClient = com.vitria.component.server.client.VirtualServerClient;
var ServerInfo = com.vitria.domainservice.ServerInfo

function getServerStatus(status)
{
    if (status == ServerInfo.SERVER_UNKNOWN) {
        return "Unknown";
    }
    else if (status == ServerInfo.SERVER_ON) {
        return "Running";
    }
    else if (status == ServerInfo.SERVER_OFF) {
        return "Stopped";
    }
    return "Unknown";
}

function getServerInfo(server)
{
    var info = server.getServerInfo();
    var o = {
        _id_                : info.getType() + ":" + info.getName(),
        name                : info.getName(),
        type                : info.getType(),
        status              : getServerStatus(info.getStatus()),
        providerURL         : info.getNamingInfo().getNamingProviderUrl(),
        username            : info.getNamingInfo().getNamingUser(),
        password            : info.getNamingInfo().getNamingPassword(),
        backup              : info.getBackup(),
        failureRetryCount   : info.getFailureRetryCount(),
        timestamp           : info.getTimestamp(),
        description         : info.getDescription(),
        domainName          : info.getDomainName(),
        haGroup             : info.getHAGroup(),
        logicalName         : info.getLogicalName(),
        serverType          : info.getNodeType(),
        pool                : info.getPool(),
        registryName        : info.getRegistryName(),
        serverName          : info.getServerName(),
        tag                 : info.getTag(),
        tagSource           : info.getTagSource(),
        isMonitoringEnabled : server.isMonitoringEnabled(),
        cpu                 : server.getServerCpu(),
        heap                : server.getServerHeap(),
        heapAvailable       : server.getServerHeapAvailable(),
        cpuAvg              : server.getServerCpuAVG(),
        heapAvg             : server.getServerHeapAVG(),
        heapAvailableAvg    : server.getServerHeapAvailableAVG(),
    };
    if (o.type == "RuntimeServer" && info.getEsmsInfo() != null) {
        o.cepurl = info.getEsmsInfo().getNamingInfo().getNamingProviderUrl();
        o.cepmemory = info.getEsmsInfo().getMemoryQuota();
        o.cepbatchsize = info.getEsmsInfo().getBatchSize();
    }
    return o;
}

var servers = [];
var list = VirtualServerLib.listRealFeedServers(null);
if (list != null && list.size() > 0) {
    for (var i = 0; i < list.size(); i++) {
        var server = list.get(i);
        servers.push(getServerInfo(server));
    }
}
var list = VirtualServerLib.listPresentationServers(null);
if (list != null && list.size() > 0) {
    for (var i = 0; i < list.size(); i++) {
        var server = list.get(i);
        servers.push(getServerInfo(server));
    }
}
var list = VirtualServerLib.listDomainServers(null);
if (list != null && list.size() > 0) {
    for (var i = 0; i < list.size(); i++) {
        var server = list.get(i);
        servers.push(getServerInfo(server));
    }
}
var list = VirtualServerClient.listVirtualServer();
if (list != null && list.size() > 0) {
    for (var i = 0; i < list.size(); i++) {
        var server = list.get(i);
        servers.push(getServerInfo(VirtualServerLib.getRuntimeServerInfo(server.getName(), null)));
    }
}
return servers;
]]>
        </CodeText>
      </Service>
    </Services>
    <Resources>
      <Resource uuid="b6bd80d9-065e-472f-89f4-b68c83e9ef06" name="MenubarAndToolbar" type="application/json" size="0" private="false">
        <Description>
          <![CDATA[]]>
        </Description>
      </Resource>
      <Resource uuid="58bde02d-ae39-4e75-8ceb-67d195d39f4d" name="MenubarOnly" type="application/json" size="881" private="false">
        <Description>
          <![CDATA[]]>
        </Description>
      </Resource>
      <Resource uuid="713c3e25-cb22-4b19-8d8a-1192e61a78ee" name="SAMPLE" type="application/json" size="1180" private="false">
        <Description>
          <![CDATA[]]>
        </Description>
      </Resource>
      <Resource uuid="fb988af1-dd7d-4c7f-8d4c-b2330044f23e" name="SidebarOnly" type="text/plain" size="0" private="false">
        <Description>
          <![CDATA[]]>
        </Description>
      </Resource>
      <Resource uuid="55b58f6e-562b-4707-818e-6ffdd05ec9b6" name="ToolbarOnly" type="application/json" size="0" private="false">
        <Description>
          <![CDATA[]]>
        </Description>
      </Resource>
    </Resources>
    <Plugins>
    </Plugins>
  </ModelInfo>
</DashboardPluginModel>